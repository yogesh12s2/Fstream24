<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChadStreamz Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/x-icon" href="https://chadstreamz.sbs/favicon.svg"/>

<style>
    /* --- VARIABLES --- */
    :root { --brand-red: #e50914; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    body { margin: 0; background-color: #000; color: #fff; font-family: sans-serif; }

    /* --- VIDEO CONTAINER --- */
    .video-container {
        position: relative; width: 100%; aspect-ratio: 16/9;
        background: #000; overflow: hidden;
    }
    video {
        width: 100%; height: 100%; display: block;
        object-fit: contain; transition: object-fit 0.4s ease;
    }
    video.fill-mode { object-fit: cover; }

    /* FORCE LANDSCAPE HACK */
    .video-container.force-landscape {
        position: fixed; top: 0; left: 0; width: 100vh !important; height: 100vw !important;
        z-index: 9999; transform-origin: top left;
        transform: rotate(90deg) translateY(-100%);
    }

    /* --- LAYERS --- */
    /* Z-Index Strategy:
       10: Video
       20: Watermark
       30: Tap Feedback
       40: Bottom Controls (Container)
       50: Loaders
       60: Center Buttons (Must be highest to be clickable)
    */
    
    .watermark { position: absolute; top: 20px; right: 20px; width: 60px; opacity: 0.7; z-index: 20; pointer-events: none; }

    /* LOADERS */
    .loader-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        display: flex; justify-content: center; align-items: center;
        z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.3s;
    }
    .loader-overlay.active { opacity: 1; }
    #initialLoader { background: #000; z-index: 70; }
    #bufferLoader { background: rgba(0,0,0,0.3); }

    .spinner {
        width: 50px; height: 50px; border-radius: 50%;
        border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--brand-red);
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- CENTER CONTROLS (Top Layer) --- */
    .center-wrapper {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        /* FIX: High Z-index ensures it sits ABOVE the bottom controls gradient */
        z-index: 60; 
        display: flex; align-items: center; justify-content: center; gap: 40px;
        pointer-events: none; /* Container passes clicks */
        opacity: 0; transition: opacity 0.2s;
    }
    .center-wrapper.visible { opacity: 1; }

    /* Buttons are clickable */
    .center-main-btn {
        width: 70px; height: 70px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; border-radius: 50%;
        background: rgba(0,0,0,0.4); 
        transition: transform 0.2s, background 0.2s;
        backdrop-filter: blur(2px);
        pointer-events: auto; /* FIX: Explicitly auto */
    }
    .center-main-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.6); }
    .center-main-btn svg { width: 36px; height: 36px; fill: #fff; }

    .seek-btn {
        width: 50px; height: 50px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; border-radius: 50%;
        background: rgba(0,0,0,0.3);
        transition: transform 0.2s;
        pointer-events: auto; /* FIX: Explicitly auto */
    }
    .seek-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.5); }
    .seek-btn svg { width: 26px; height: 26px; fill: #fff; }

    /* --- BOTTOM CONTROLS --- */
    .controls {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 40px 20px 15px 20px;
        display: flex; flex-direction: column; gap: 8px; z-index: 40;
        opacity: 0; transform: translateY(10px);
        transition: opacity 0.3s, transform 0.3s;
        
        /* FIX: Ensure the transparent gradient doesn't block clicks on video center */
        pointer-events: none; 
    }
    .controls.visible { opacity: 1; transform: translateY(0); }
    
    /* Re-enable clicks for actual buttons/slider */
    .progress-box, .btn-row { pointer-events: auto; }

    /* Progress Bar */
    .progress-box { width: 100%; position: relative; height: 20px; display: flex; align-items: center; cursor: pointer; }
    input[type=range] {
        width: 100%; -webkit-appearance: none; background: transparent; height: 4px; 
        border-radius: 2px; background: rgba(255,255,255,0.3);
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 14px; width: 14px;
        background: var(--brand-red); border-radius: 50%;
        margin-top: -5px; box-shadow: 0 0 10px var(--brand-red);
    }

    .btn-row { display: flex; justify-content: space-between; align-items: center; }
    .grp { display: flex; align-items: center; gap: 20px; }
    button { background: none; border: none; color: #eee; cursor: pointer; padding: 0; }
    button:hover { color: #fff; transform: scale(1.1); }
    button svg { width: 28px; height: 28px; fill: currentColor; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }
    .time-txt { font-size: 13px; color: #ddd; font-weight: 500; }
    .fit-btn.active { color: var(--brand-red); }

    /* --- TAP FEEDBACK --- */
    .tap-feedback {
        position: absolute; top: 0; bottom: 0; width: 40%;
        display: flex; justify-content: center; align-items: center;
        font-weight: bold; font-size: 18px; z-index: 30; pointer-events: none;
        opacity: 0; transition: opacity 0.2s;
    }
    .tap-left { left: 0; background: linear-gradient(to right, rgba(255,255,255,0.1), transparent); }
    .tap-right { right: 0; background: linear-gradient(to left, rgba(255,255,255,0.1), transparent); }
    .tap-feedback.animate { animation: ripple 0.5s ease-out forwards; }
    @keyframes ripple { 0% { opacity: 1; } 100% { opacity: 0; } }

    /* --- PAGE --- */
    .content { max-width: 1200px; margin: 0 auto; padding: 25px 5%; }
    .dl-btn { background: #222; color: #fff; padding: 10px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; border: 1px solid #444; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .card { border-radius: 8px; overflow: hidden; cursor: pointer; }
    .card img { width: 100%; display: block; aspect-ratio: 2/3; object-fit: cover; }

</style>
</head>
<body>

<div class="video-container" id="player">
    <img src="https://chadstreamz.sbs/assets/images/log2.png" class="watermark" alt="Logo">
    
    <div class="loader-overlay active" id="initialLoader"><div class="spinner"></div></div>
    <div class="loader-overlay" id="bufferLoader"><div class="spinner"></div></div>

    <div class="center-wrapper visible" id="centerWrapper">
        <div class="seek-btn" id="rwdBtn">
            <svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg>
        </div>
        
        <div class="center-main-btn" id="centerBtn">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        
        <div class="seek-btn" id="fwdBtn">
            <svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>
        </div>
    </div>

    <div class="tap-feedback tap-left" id="tapLeft"><span>« 10s</span></div>
    <div class="tap-feedback tap-right" id="tapRight"><span>10s »</span></div>

    <video id="vid" poster="https://chadstreamz.sbs/assets/images/log2.png" playsinline preload="auto">
        <source src="{{ mediaLink }}" type="video/mp4">
        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
    </video>

    <div class="controls visible" id="ui">
        <div class="progress-box">
            <input type="range" id="seek" min="0" max="100" value="0" step="0.1">
        </div>
        <div class="btn-row">
            <div class="grp">
                <button id="playToggle"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <span class="time-txt" id="timer">00:00 / 00:00</span>
            </div>
            <div class="grp">
                <button id="mute"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
                <button id="fit" class="fit-btn"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zm-10-7h2v2h-2v-2zm-4 0h2v2H7v-2zm8 0h2v2h-2v-2z"/></svg></button>
                <button id="fs"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:20px;">
        <h3>Now Watching</h3>
        <a id="dl" class="dl-btn" href="#">⬇ Download</a>
    </div>
    <div class="grid" id="sugg"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const vid = document.getElementById('vid');
    const ui = document.getElementById('ui');
    const centerWrapper = document.getElementById('centerWrapper');
    const centerBtn = document.getElementById('centerBtn');
    const rwdBtn = document.getElementById('rwdBtn');
    const fwdBtn = document.getElementById('fwdBtn');
    const playToggle = document.getElementById('playToggle');
    const seek = document.getElementById('seek');
    const container = document.getElementById('player');
    const initLoader = document.getElementById('initialLoader');
    const bufLoader = document.getElementById('bufferLoader');
    
    const mediaLink = "{{ mediaLink }}" || vid.querySelector('source').src;
    document.getElementById('dl').href = mediaLink;
    const storageKey = "chad_resume_" + encodeURIComponent(mediaLink);
    let hideTimeout;
    let lastTap = 0;

    const svgPlay = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    const svgPause = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

    // --- 1. PLAYBACK ---
    function togglePlayback(e) {
        if(e) e.stopPropagation();
        if (vid.paused) vid.play(); else vid.pause();
    }

    function updateIcons() {
        if (vid.paused) {
            playToggle.innerHTML = svgPlay;
            centerBtn.innerHTML = svgPlay;
            centerWrapper.classList.add('visible');
            ui.classList.add('visible');
            clearTimeout(hideTimeout);
        } else {
            playToggle.innerHTML = svgPause;
            centerBtn.innerHTML = svgPause;
            centerWrapper.classList.add('visible'); // Keep visible momentarily
            startAutoHider();
        }
    }

    vid.addEventListener('play', updateIcons);
    vid.addEventListener('pause', updateIcons);

    centerBtn.addEventListener('click', togglePlayback);
    playToggle.addEventListener('click', togglePlayback);

    // --- 2. SEEK ---
    rwdBtn.addEventListener('click', (e) => { e.stopPropagation(); vid.currentTime -= 10; startAutoHider(); });
    fwdBtn.addEventListener('click', (e) => { e.stopPropagation(); vid.currentTime += 10; startAutoHider(); });

    // --- 3. AUTO HIDE ---
    function startAutoHider() {
        clearTimeout(hideTimeout);
        if(!vid.paused) {
            hideTimeout = setTimeout(() => {
                ui.classList.remove('visible');
                centerWrapper.classList.remove('visible');
            }, 3000);
        }
    }

    container.addEventListener('mouseenter', () => {
        ui.classList.add('visible'); centerWrapper.classList.add('visible'); clearTimeout(hideTimeout);
    });
    container.addEventListener('mouseleave', () => { if(!vid.paused) startAutoHider(); });

    // --- 4. GESTURES ---
    container.addEventListener('click', (e) => {
        const now = Date.now();
        const diff = now - lastTap;
        if (diff < 400 && diff > 0) handleDoubleTap(e);
        else {
            // Single Tap Logic
            if (ui.classList.contains('visible') && !vid.paused) {
                ui.classList.remove('visible');
                centerWrapper.classList.remove('visible');
            } else {
                ui.classList.add('visible');
                centerWrapper.classList.add('visible');
                startAutoHider();
            }
        }
        lastTap = now;
    });

    // Don't let control clicks trigger container toggle
    ui.addEventListener('click', (e) => { e.stopPropagation(); startAutoHider(); });

    function handleDoubleTap(e) {
        const isRotated = container.classList.contains('force-landscape');
        let clickPos, limit;
        if (isRotated) { clickPos = e.clientY; limit = window.innerHeight; }
        else { clickPos = e.clientX - container.getBoundingClientRect().left; limit = container.getBoundingClientRect().width; }

        if (clickPos < limit * 0.35) { vid.currentTime -= 10; flash('tapLeft'); }
        else if (clickPos > limit * 0.65) { vid.currentTime += 10; flash('tapRight'); }
        else togglePlayback();
    }
    function flash(id) {
        const el = document.getElementById(id);
        el.classList.remove('animate');
        void el.offsetWidth; el.classList.add('animate');
    }

    // --- 5. SYSTEM ---
    vid.preload = "auto";
    vid.addEventListener('canplay', () => initLoader.classList.remove('active'));
    if(vid.readyState >= 3) initLoader.classList.remove('active');
    vid.addEventListener('waiting', () => bufLoader.classList.add('active'));
    vid.addEventListener('playing', () => { bufLoader.classList.remove('active'); initLoader.classList.remove('active'); });

    function fmt(s) { const m=Math.floor(s/60), ss=Math.floor(s%60); return `${m}:${ss<10?'0'+ss:ss}`; }
    vid.addEventListener('timeupdate', () => {
        if(!isNaN(vid.duration)){
            const p = (vid.currentTime / vid.duration) * 100;
            seek.value = p;
            seek.style.background = `linear-gradient(to right, #e50914 ${p}%, rgba(255,255,255,0.2) ${p}%)`;
            document.getElementById('timer').innerText = `${fmt(vid.currentTime)} / ${fmt(vid.duration)}`;
            if(Math.floor(vid.currentTime)%2===0) localStorage.setItem(storageKey, vid.currentTime);
        }
    });
    seek.addEventListener('input', () => { vid.currentTime = (seek.value/100)*vid.duration; startAutoHider(); });

    document.getElementById('mute').addEventListener('click', function(){ vid.muted = !vid.muted; this.style.opacity = vid.muted ? 0.5 : 1; });
    document.getElementById('fit').addEventListener('click', function(){ this.classList.toggle('active', vid.classList.toggle('fill-mode')); });
    document.getElementById('fs').addEventListener('click', () => {
        if(!document.fullscreenElement) container.requestFullscreen ? container.requestFullscreen() : vid.webkitEnterFullscreen();
        else document.exitFullscreen();
    });
    document.addEventListener('fullscreenchange', () => {
        if(document.fullscreenElement) {
            if(screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(()=>{});
            container.classList.add('force-landscape');
        } else {
            container.classList.remove('force-landscape');
            if(screen.orientation) screen.orientation.unlock();
        }
    });

    vid.addEventListener('loadedmetadata', () => { const t=parseFloat(localStorage.getItem(storageKey)); if(t) vid.currentTime=t; });
    async function loadSugg() {
        try {
            const r = await fetch("https://chadstreamz.sbs/api/random_movies.php");
            const d = await r.json();
            const g = document.getElementById('sugg');
            g.innerHTML = "";
            d.forEach(m => {
                const c = document.createElement("div"); c.className = "card";
                c.innerHTML = `<img src="${m.image_url}" loading="lazy">`;
                c.onclick = () => { if(m.download) window.location.href = m.download; };
                g.appendChild(c);
            });
        } catch(e){}
    }
    loadSugg();
});
</script>
</body>
</html>
